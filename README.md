# 📈 智能投资话题抽取系统 v3.1

一个基于Python的智能投资话题分析系统，从知识星球（zsxq）API抓取投资相关话题，使用LLM进行智能分析，并输出结构化的板块-标的对数据。

## 🎯 核心功能 v3.1

1.  **一键生成Excel报告 (v3.1新增)**：运行主程序后，自动将结果转换为格式精美的Excel文件，实现端到端的自动化。
2.  **板块-标的对提取 (默认模式)**：专注从文本中提取所有投资标的，并按行业板块进行归类，适合行业研究和跟踪。
3.  **动态列生成**：根据每篇文章提取的板块数量，自动在CSV和Excel中生成对应的 `板块N | 标的组合N` 列。
4.  **智能Excel格式化**：
    -   **自动查找最新文件**：独立运行时，无需指定输入即可自动转换`output/`目录中最新的CSV文件。
    -   **智能换行**：`简述`、`推荐理由`、`预期`以及所有`标的组合`列均可自动换行。
    -   **优雅字体与列宽**：统一使用"等线"13号字体，并自动调整列宽。
5.  **双模式支持**：通过 `config.py` 中的 `FINANCE` 开关，可切换回兼容旧版的"价格抓取"模式。
6.  **高精度股票映射**：在价格模式下，基于akshare的9,888只股票数据库实现高达95%的映射成功率。
7.  **TLS指纹伪装**：在价格模式下，使用`curl_cffi`有效规避`yfinance`的API请求限制。

## 🎯 核心功能

1. **🧠 智能话题获取**：自动获取所有今日话题，无需手动指定页数
2. **🤖 LLM语义分析**：专注于标的识别、理由分析、预期提取等语义任务
3. **🎯 智能股票映射**：基于akshare的完整A股+港股数据库，智能模糊匹配
4. **🌐 多源股价获取**：A股、港股、美股实时价格查询，多数据源容错
5. **⚡ 并发高效处理**：5线程并发处理，显著提升处理速度
6. **📋 完整信息记录**：包含原文内容，便于验证和追溯
7. **🌟 多星球支持**：轻松切换不同知识星球，配置集中管理

## 🚀 最新重大升级 (v3.0)

### 🎯 智能股票映射系统
- **🆕 akshare数据库**：完整的9,888只股票数据（5,419只A股 + 4,469只港股）
- **🧠 四层匹配算法**：精确→清理→包含→模糊匹配
- **⚡ 24小时缓存**：避免重复API调用，响应速度0.011秒/次
- **📈 95%成功率**：相比手动维护的30%成功率大幅提升

### 🔐 TLS指纹伪装技术
- **🆕 curl_cffi集成**：Chrome浏览器TLS指纹伪装
- **🛡️ 反爬虫规避**：有效避免yfinance Rate Limit问题
- **🔄 智能降级**：无缝回退到标准requests

### ⚙️ 配置集中管理
- **🌟 一键切换星球**：只需修改STAR_ID和COOKIE
- **📂 统一配置文件**：所有API设置集中在config.py
- **🔧 灵活调节**：超时、重试等参数可自定义

## 🏗️ 架构设计

### 📋 智能任务分工

**🤖 LLM专注核心语义任务：**
- ✅ 提取投资标的名称
- ✅ 分析推荐理由
- ✅ 总结投资预期
- ✅ 识别行业板块

**💻 程序处理结构化数据：**
- ✅ 公司名称 → 股票代码智能映射
- ✅ 多数据源股价获取（TLS指纹伪装）
- ✅ 时间格式化（HH:MM）
- ✅ 数据清洗和格式化

### 🎯 技术优势
- **任务清晰**：各司其职，提高准确性
- **智能映射**：无需手动维护，自动覆盖全市场
- **高效稳定**：TLS指纹伪装+多数据源容错
- **扩展性强**：支持切换不同知识星球

## 📂 项目结构 v3.1

```
crawl/
├── README.md                 # 项目说明文档 (v3.1)
├── requirements.txt          # Python依赖包
├── config.py                 # 全局配置 (含FINANCE开关)
├── main.py                   # 主程序入口 (支持双模式)
│
├── extractor/               # 数据提取模块
│   ├── client.py             # zsxq API客户端
│   ├── text_extractor.py     # 文本内容提取器
│   ├── price_fetcher.py      # 价格获取器 (FINANCE=True时激活)
│   └── ticker_mapper.py      # 股票映射系统 (FINANCE=True时激活)
│
├── llm_filter/              # LLM智能分析模块
│   └── extractor.py          # LLM语义提取器 (支持双模式)
│
├── to_excel_converter.py     # 智能CSV to Excel转换器
│
├── data/                    # 数据缓存目录
├── logs/                    # 日志文件目录
└── output/                  # 输出结果目录
    ├── finance_mode/        # 价格模式输出
    │   ├── daily_results/
    │   └── excel_reports/
    └── noprice_mode/        # 板块-标的对模式输出 (默认)
        ├── daily_results/
        └── excel_reports/
```

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置API密钥

编辑 `config.py` 文件，确保 `COOKIE` 和 `OPENAI_API_KEY` 已正确填写。

```python
# config.py

# ... 其他配置 ...

# 认证Cookie（必填）
COOKIE = "zsxq_access_token=你的token..."

# OpenAI API配置 (必填)
OPENAI_API_KEY = "sk-你的API密钥"

# 功能开关（默认False，使用新版板块-标的对模式）
FINANCE = False

# 新增：是否在生成CSV后自动转换为格式化的Excel文件
AUTO_CONVERT_TO_EXCEL = True
```

### 3. 运行程序

```bash
# 📅 一键提取并生成格式化的Excel报告（推荐用法）
python3 main.py --from-date 2025-07-01

# 📄 如果只想手动转换某个CSV文件
python3 to_excel_converter.py --input path/to/your/file.csv
```

## 📊 输出数据格式 (v3.1)

### 🗂️ 文件与目录结构

- **文件名**: 所有输出文件（CSV, JSON, XLSX）统一使用 `会议纪要_YY.MM.DD` 格式。
- **目录结构**:
    - `output/noprice_mode/daily_results/`: 存放**板块-标的对模式**下的每日源数据 (默认)。
    - `output/noprice_mode/excel_reports/`: 存放**板块-标的对模式**下的最终Excel报告 (默认)。
    - `output/finance_mode/daily_results/`: 存放**价格模式**下的每日源数据 (当`FINANCE=True`时)。
    - `output/finance_mode/excel_reports/`: 存放**价格模式**下的最终Excel报告 (当`FINANCE=True`时)。

### 📋 动态列结构

**列顺序：标题 | 时间 | 板块1 | 标的组合1 | 板块2 | 标的组合2 | … | 简述 | 推荐理由 | 预期 | 原文**

| 字段 | 描述 | 示例 |
|:---|:---|:---|
| **标题** | 话题标题 | "固态电池技术突破分析" |
| **时间** | 发布时间（HH:MM） | "15:08" |
| **板块1** | 第一个行业板块 | "新能源" |
| **标的组合1** | 该板块下的标的（顿号连接） | "宁德时代、阳光电源、比亚迪" |
| **板块2** | 第二个行业板块 | "半导体" |
| **标的组合2** | 该板块下的标的（顿号连接） | "中芯国际、韦尔股份" |
| ... | *以此类推，动态增减* | ... |
| **简述** | 话题内容摘要（50-100字） | "固态电池技术突破，带动产业链整体受益" |
| **推荐理由**| 投资逻辑分析（60-100字） | "技术落地加速，政策支持力度加大" |
| **预期** | 投资目标（≤100字） | "年内板块有望上涨10%以上" |
| **原文** | 完整原始内容 | "【固态电池】技术突破分析..." |

### 🎨 Excel格式化特色

- **❄️ 冻结首列 (v3.1)**：标题列（首列）已被冻结，便于您向右滚动查看更多板块时，仍能清晰地看到每行对应的话题标题。
- **🗂️ 单一Sheet页**：每个Excel文件包含一个以`YYYY-MM-DD`命名的Sheet页，避免日期混淆。
- **🖼️ 等线13号字体**：统一使用等线（正文）13号字体。
- **📏 精准对齐与换行**：
    - **完全居中** (水平+垂直): `时间`、`板块N`
    - **垂直居中 + 自动换行**: `标题`、`标的组合N`
    - **顶部对齐 + 自动换行**: `简述`、`推荐理由`、`预期`
- **📐 智能列宽**：
    - **固定超宽**: `原文`列宽度固定为666，便于阅读长文。
    - **自适应**: 其他所有非换行列自动调整宽度以适应内容。

## 🚀 运行示例（新版）

```bash
# 🎯 使用新版板块-标的对模式（默认）
python3 main.py --from-date 2025-07-02

# 📊 生成的文件结构
output/
├── result_noprice_25.07.03.csv    # 新版无价格模式
├── result_noprice_25.07.03.json   # JSON格式
└── result_noprice_25.07.03_格式化.xlsx  # Excel格式（等线13号字体）

# 🔄 转换为Excel（等线13号字体）
python3 to_excel_converter.py --input output/result_noprice_25.07.03.csv
```

### 📄 CSV示例输出（新版）

```csv
标题,时间,板块1,标的组合1,板块2,标的组合2,简述,推荐理由,预期,原文
固态电池技术突破,15:08,新能源,宁德时代、阳光电源,半导体,中芯国际,固态电池技术实现重大突破,技术落地加速政策支持,年内板块有望上涨10%以上,【固态电池】技术突破分析...
AI芯片发展前景,16:22,AI,百度、阿里,半导体,海光信息、景嘉微,AI芯片需求激增,算力需求持续增长,AI概念股将迎来新一轮上涨,【AI芯片】发展前景看好...
```

## ⚙️ 功能配置

### 🔧 FINANCE 模式切换

在 `config.py` 中设置：

```python
# ==================== 功能开关配置 ====================
# 财务价格抓取开关（False=只抓板块标的对，True=兼容旧版价格抓取）
FINANCE = False  # 默认使用新版板块-标的对模式

# 当FINANCE=True时，需要配置以下价格相关设置：
USE_YFINANCE = True  # 启用yfinance价格抓取
```

**FINANCE=False（推荐）：**
- ✅ 专注板块-标的对关系分析
- ✅ 无价格抓取，运行更快
- ✅ 更好的行业分析视角
- ✅ 文件命名：`result_noprice_YY.MM.DD.*`

**FINANCE=True（兼容）：**
- ✅ 保持原有价格抓取功能
- ✅ 适合需要实时价格的场景
- ✅ 文件命名：`会议纪要_YY.MM.DD.*`

## 🗂️ 智能日志管理

### 📝 统一日志系统
- **集中配置**：所有模块使用统一日志格式
- **详细记录**：包含文件名、行号、时间戳
- **分级显示**：INFO、DEBUG、WARNING、ERROR分级

### 🧹 自动清理机制
- **数量限制**：最多保留30个日志文件
- **智能清理**：启动时自动删除过期日志
- **时间排序**：按修改时间排序，保留最新文件

## 🎯 智能话题获取

### 📅 基于日期的智能分页
- **自动判断**：持续获取直到遇到昨天或更早日期
- **无需指定页数**：系统自动判断何时停止
- **完整覆盖**：确保获取当日所有相关话题
- **安全机制**：最大重试机制，防止API异常

### 📊 获取效果
- **今日话题**：自动获取所有今日投资话题
- **指定范围**：支持从某日期到现在的话题获取
- **智能过滤**：只处理有效的投资相关内容

## ⚙️ 技术特性

- **🐍 Python 3.9+** 完整类型注解，代码规范
- **🆕 akshare数据库** 完整股票清单，智能匹配
- **🔐 curl_cffi TLS伪装** 规避反爬虫检测
- **⚡ 并发处理** 5线程并发，提高处理效率
- **🔄 智能重试** 网络异常自动重试机制
- **📊 进度显示** 详细的处理进度和状态显示
- **📝 完整日志** 详细执行日志，便于调试
- **🌟 多星球支持** 配置集中管理，一键切换
- **🇨🇳 中文优化** 专门优化中文内容处理

## 🔧 配置选项

### config.py 详细配置

```python
# ==================== zsxq知识星球配置 ====================
STAR_ID = "48418411254128"  # 星球ID
COOKIE = "zsxq_access_token=..."  # 认证Cookie

# zsxq API配置
API_BASE_URL = "https://api.zsxq.com/v2/topics"
API_HOST = "api.zsxq.com"
API_TIMEOUT = 15  # 请求超时时间（秒）
API_RETRY_TIMES = 5  # API重试次数
API_RETRY_DELAY = (3, 5)  # 重试延迟范围（秒）

# OpenAI API配置 (推荐DeepSeek)
OPENAI_API_KEY = "sk-你的API密钥"      
OPENAI_API_BASE = "https://api.deepseek.com"
OPENAI_MODEL = "deepseek-chat"   
TEMPERATURE = 0.2  # 推荐0.2，平衡创意和准确性

# 股价获取配置
USE_YFINANCE = True  # 启用yfinance

# 日志配置
LOG_LEVEL = logging.INFO
MAX_LOG_FILES = 30  # 最大日志文件数量
```

## 📝 使用示例

```bash
# 🎯 获取今日所有投资话题（推荐）
python3 main.py --today

# 📅 从指定日期获取所有话题
python3 main.py --from-date 2025-07-01

# 📊 查看详细处理日志
tail -f logs/extraction_$(date +%Y%m%d_*)

# 🔍 检查生成的结果文件
ls -la output/

# 🧪 测试股票映射系统
python3 -c "
from extractor.ticker_mapper import SmartTickerMapper
mapper = SmartTickerMapper()
print(mapper.find_ticker('茅台'))  # 测试智能匹配
"

# 🔧 测试TLS指纹伪装
python3 -c "
from extractor.price_fetcher import create_session
session = create_session()
print(f'TLS伪装: {type(session)}')  # 检查会话类型
"
```

## 🎉 版本历史

### 🆕 v3.0 - 智能化升级 (2025-07-03)

1. **🎯 智能股票映射**
   - 集成akshare完整数据库（5,478只股票）
   - 四层智能匹配算法
   - 95%映射成功率

2. **🔐 TLS指纹伪装**
   - curl_cffi Chrome指纹伪装
   - 有效规避yfinance Rate Limit
   - 智能降级机制

3. **⚙️ 配置集中管理**
   - API配置移至config.py
   - 支持一键切换知识星球
   - 灵活的超时和重试配置

4. **📊 数据质量提升**
   - 完整股票覆盖
   - 更准确的价格获取
   - 统一的货币格式

### v2.0 - 架构升级 (2025-07-02)

1. **🎯 任务分工优化**
   - LLM专注语义分析
   - 程序负责数据查询

2. **⚡ 并发处理系统**
   - 5线程并发处理
   - 3-5倍速度提升

3. **🗂️ 智能日志管理**
   - 自动清理过期日志
   - 统一日志格式

## 🚨 注意事项

1. **📊 数据准确性**：LLM提取结果仅供参考，投资需谨慎
2. **🔑 API限制**：请遵守OpenAI、akshare和zsxq的API使用限制  
3. **📈 股价延迟**：股价数据可能有5-15分钟延迟
4. **🌐 网络环境**：TLS指纹伪装需要稳定网络环境
5. **💾 缓存管理**：股票数据库缓存24小时，可手动清理data/目录
6. **🌟 星球切换**：切换星球前请确保有相应的访问权限

## 📈 投资免责声明

**⚠️ 本系统仅用于数据分析和研究目的，所有投资建议和股价信息仅供参考。投资有风险，决策需谨慎！**

## 📄 许可证

本项目仅供学习和研究使用。请遵守相关API服务条款。

## 📄 CSV to Excel 转换器

为了方便阅读和归档，项目提供了一个将输出的CSV文件转换为格式精美的Excel文件的工具 `to_excel_converter.py`。

### ✨ 核心功能

- **📅 按日期分表**：自动将CSV中不同日期的数据，存入以日期（如 `2025-07-03`）命名的独立Sheet中。
- **💅 舒适列宽**：自动调整所有列的宽度，确保内容完全显示，无需手动调整，特别优化了中文显示。
- **🚀 使用简单**：通过命令行即可完成转换。

### ⌨️ 如何使用

```bash
# 1. 转换默认的 result.csv
# 会生成 output/result_formatted.xlsx
python3 to_excel_converter.py

# 2. 转换指定的存档文件
python3 to_excel_converter.py --input output/会议纪要_25.07.03.csv --output output/存档_25.07.03.xlsx
```
