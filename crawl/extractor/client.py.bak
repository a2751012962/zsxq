"""
æ­¤æ¨¡å—è´Ÿè´£ä»zsxq APIè·å–è¯é¢˜æ•°æ®
"""
import time
from datetime import datetime, timezone, timedelta
from typing import List, Dict, Any, Optional, Tuple, Callable
import random

import requests

from config import STAR_ID, COOKIE, API_BASE_URL, API_HOST, API_TIMEOUT, API_RETRY_TIMES, API_RETRY_DELAY, get_logger, MAX_TOPIC_PAGES
import config

# è®¾ç½®æ—¥å¿—å™¨
logger = get_logger(__name__)

def è·å–ä»Šæ—¥æ—¶é—´èŒƒå›´():
    """
    è·å–ä»Šæ—¥çš„æ—¶é—´èŒƒå›´ï¼ˆå¼€å§‹å’Œç»“æŸæ—¶é—´ï¼‰
    è¿”å› ISO æ ¼å¼çš„æ—¶é—´å­—ç¬¦ä¸²
    """
    # è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ UTC+8ï¼‰
    åŒ—äº¬æ—¶åŒº = timezone(timedelta(hours=8))
    ç°åœ¨ = datetime.now(åŒ—äº¬æ—¶åŒº)
    
    # ä»Šæ—¥å¼€å§‹æ—¶é—´ï¼ˆ00:00:00ï¼‰
    ä»Šæ—¥å¼€å§‹ = ç°åœ¨.replace(hour=0, minute=0, second=0, microsecond=0)
    
    # ä»Šæ—¥ç»“æŸæ—¶é—´ï¼ˆ23:59:59ï¼‰
    ä»Šæ—¥ç»“æŸ = ç°åœ¨.replace(hour=23, minute=59, second=59, microsecond=999999)
    
    return ä»Šæ—¥å¼€å§‹.isoformat(), ä»Šæ—¥ç»“æŸ.isoformat()

def è·å–æ—¥æœŸèŒƒå›´(èµ·å§‹æ—¥æœŸ: str):
    """
    è·å–ä»æŒ‡å®šæ—¥æœŸåˆ°ç°åœ¨çš„æ—¶é—´èŒƒå›´
    
    å‚æ•°:
        èµ·å§‹æ—¥æœŸ (str): å¼€å§‹æ—¥æœŸï¼Œæ ¼å¼ä¸º YYYY-MM-DD
        
    è¿”å›:
        tuple: (å¼€å§‹æ—¶é—´ISOå­—ç¬¦ä¸², ç»“æŸæ—¶é—´ISOå­—ç¬¦ä¸²)
    """
    åŒ—äº¬æ—¶åŒº = timezone(timedelta(hours=8))
    
    # è§£æå¼€å§‹æ—¥æœŸ
    try:
        å¼€å§‹æ—¥æœŸ = datetime.strptime(èµ·å§‹æ—¥æœŸ, "%Y-%m-%d")
        å¼€å§‹æ—¶é—´ = å¼€å§‹æ—¥æœŸ.replace(hour=0, minute=0, second=0, microsecond=0, tzinfo=åŒ—äº¬æ—¶åŒº)
    except ValueError:
        raise ValueError(f"æ— æ•ˆçš„æ—¥æœŸæ ¼å¼: {èµ·å§‹æ—¥æœŸ}. åº”ä¸º YYYY-MM-DD")
    
    # ç»“æŸæ—¶é—´ä¸ºå½“å‰æ—¶é—´
    ç»“æŸæ—¶é—´ = datetime.now(åŒ—äº¬æ—¶åŒº)
    
    return å¼€å§‹æ—¶é—´.isoformat(), ç»“æŸæ—¶é—´.isoformat()

def è·å–è¯é¢˜é¡µé¢(ç»“æŸæ—¶é—´: str = "", ä»…ä»Šæ—¥: bool = True, èµ·å§‹æ—¥æœŸ: str = "") -> Dict[str, Any]:
    """
    ä»zsxq APIè·å–å•é¡µè¯é¢˜æ•°æ®

    å‚æ•°:
        ç»“æŸæ—¶é—´ (str): ç”¨äºåˆ†é¡µçš„ç»“æŸæ—¶é—´ï¼Œä¸ºç©ºåˆ™è·å–æœ€æ–°è¯é¢˜
        ä»…ä»Šæ—¥ (bool): æ˜¯å¦åªè¿‡æ»¤ä»Šæ—¥è¯é¢˜ï¼ˆåœ¨å®¢æˆ·ç«¯è¿‡æ»¤ï¼‰
        èµ·å§‹æ—¥æœŸ (str): è¿‡æ»¤çš„å¼€å§‹æ—¥æœŸ (YYYY-MM-DDæ ¼å¼)ï¼Œä¸ºç©ºåˆ™ä¸ä½¿ç”¨ï¼ˆåœ¨å®¢æˆ·ç«¯è¿‡æ»¤ï¼‰

    è¿”å›:
        Dict[str, Any]: APIè¿”å›çš„JSONå“åº”
    """
    # ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆå½“å‰æ—¶é—´çš„Unixæ—¶é—´æˆ³ï¼‰
    import time as time_module
    timestamp = str(int(time_module.time()))
    
    è¯·æ±‚å¤´ = {
        "Accept": "application/json, text/plain, */*",
        "Accept-Encoding": "gzip, deflate, br, zstd",
        "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive",
        "Cookie": COOKIE,
        "Host": API_HOST,
        "Origin": "https://wx.zsxq.com",
        "Pragma": "no-cache",
        "Priority": "u=1, i",
        "Referer": "https://wx.zsxq.com/",
        "Sec-Ch-Ua": '"Google Chrome";v="137", "Chromium";v="137", "Not/A)Brand";v="24"',
        "Sec-Ch-Ua-Mobile": "?0",
        "Sec-Ch-Ua-Platform": '"macOS"',
        "Sec-Fetch-Dest": "empty",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "same-site",
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36",
        "X-Aduid": "f0185a8e3-7586-5bcf-7a8d-ebd0fdf0854",
        "X-Request-Id": f"req_{timestamp}_{hash(timestamp) % 100000:05d}",
        "X-Timestamp": timestamp,
        "X-Version": "2.77.0"
    }
    å‚æ•° = {
        "scope": "all",
        "count": 20,
    }
    
    # åªæ·»åŠ åˆ†é¡µçš„ç»“æŸæ—¶é—´ï¼Œç§»é™¤begin_timeå’Œend_timeé¿å…æ ¼å¼é”™è¯¯
    if ç»“æŸæ—¶é—´:
        å‚æ•°["end_time"] = ç»“æŸæ—¶é—´

    ç½‘å€ = API_BASE_URL.replace("/v2/topics", f"/v2/groups/{STAR_ID}/topics")
    
    logger.debug(f"æ­£åœ¨è·å–è¯é¢˜ï¼ŒURL: {ç½‘å€}")
    logger.debug(f"è¯·æ±‚å‚æ•°: {å‚æ•°}")

    try:
        å“åº” = requests.get(ç½‘å€, headers=è¯·æ±‚å¤´, params=å‚æ•°, timeout=API_TIMEOUT)
        å“åº”.raise_for_status()
        
        # è®°å½•æˆåŠŸå“åº”çš„è¯¦ç»†ä¿¡æ¯
        json_data = å“åº”.json()
        if "resp_data" in json_data and "topics" in json_data["resp_data"]:
            topics_count = len(json_data["resp_data"]["topics"])
            logger.debug(f"æˆåŠŸè·å–APIå“åº”ï¼ŒåŒ…å« {topics_count} ä¸ªè¯é¢˜")
        
        return json_data
    except requests.exceptions.RequestException as e:
        logger.error(f"è·å–è¯é¢˜æ—¶å‡ºé”™: {e}")
        if isinstance(e, requests.exceptions.HTTPError):
            if e.response.status_code == 429:
                logger.warning("è¯·æ±‚é¢‘ç‡å—é™ã€‚60ç§’åé‡è¯•...")
                time.sleep(60)
                return è·å–è¯é¢˜é¡µé¢(ç»“æŸæ—¶é—´, ä»…ä»Šæ—¥, èµ·å§‹æ—¥æœŸ)
            elif e.response.status_code == 401:
                logger.error("è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥Cookieæ˜¯å¦æœ‰æ•ˆ")
            elif e.response.status_code == 403:
                logger.error("è®¿é—®è¢«æ‹’ç»ï¼Œå¯èƒ½éœ€è¦æ›´æ–°è¯·æ±‚å¤´æˆ–Cookie")
        return {}

def è·å–æ‰€æœ‰ä»Šæ—¥è¯é¢˜(èµ·å§‹æ—¥æœŸ: str = "") -> List[Dict[str, Any]]:
    """
    è·å–æ‰€æœ‰ä»Šæ—¥è¯é¢˜ï¼ˆæˆ–æŒ‡å®šæ—¥æœŸèŒƒå›´çš„è¯é¢˜ï¼‰
    æŒç»­è·å–ç›´åˆ°é‡åˆ°æ˜¨å¤©æˆ–æ›´æ—©æ—¥æœŸçš„è¯é¢˜ä¸ºæ­¢

    å‚æ•°:
        èµ·å§‹æ—¥æœŸ (str): è¿‡æ»¤çš„å¼€å§‹æ—¥æœŸ (YYYY-MM-DDæ ¼å¼)ï¼Œä¸ºç©ºåˆ™åªè·å–ä»Šæ—¥è¯é¢˜

    è¿”å›:
        List[Dict[str, Any]]: æ‰€æœ‰è·å–çš„è¯é¢˜åˆ—è¡¨
    """
    æ‰€æœ‰è¯é¢˜ = []
    ç»“æŸæ—¶é—´ = ""
    é¡µç  = 0
    è¿ç»­ç©ºå“åº”æ¬¡æ•° = 0  # è®°å½•è¿ç»­ç©ºå“åº”çš„æ¬¡æ•°
    æœ€å¤§é‡è¯•æ¬¡æ•° = API_RETRY_TIMES     # æœ€å¤šé‡è¯•æ¬¡æ•°
    
    # æ˜¾è‘—çš„åˆ†é¡µå¼€å§‹æ—¥å¿—
    logger.info("=" * 60)
    if èµ·å§‹æ—¥æœŸ:
        logger.info(f"ğŸ“… å¼€å§‹è·å–ä»ã€{èµ·å§‹æ—¥æœŸ}ã€‘åˆ°ç°åœ¨çš„æ‰€æœ‰è¯é¢˜")
        ç›®æ ‡æ—¥æœŸ = èµ·å§‹æ—¥æœŸ  # è·å–ä»æŒ‡å®šæ—¥æœŸåˆ°ç°åœ¨çš„è¯é¢˜
    else:
        logger.info(f"ğŸ“… å¼€å§‹è·å–ã€ä»Šæ—¥æ‰€æœ‰è¯é¢˜ã€‘")
        ä»Šæ—¥å¼€å§‹, _ = è·å–ä»Šæ—¥æ—¶é—´èŒƒå›´()
        ç›®æ ‡æ—¥æœŸ = ä»Šæ—¥å¼€å§‹[:10]  # è·å–ä»Šæ—¥æ—¥æœŸ YYYY-MM-DD
    
    logger.info("ğŸ“‹ å°†æŒç»­è·å–ç›´åˆ°é‡åˆ°æ›´æ—©æ—¥æœŸçš„è¯é¢˜")
    logger.info("=" * 60)
    
    while True:
        é¡µç  += 1
        # çªå‡ºæ˜¾ç¤ºçš„åˆ†é¡µè¿›åº¦
        logger.info(f"ğŸ” æ­£åœ¨è·å–ç¬¬ ã€{é¡µç }ã€‘ é¡µè¯é¢˜...")
        
        æ•°æ® = è·å–è¯é¢˜é¡µé¢(ç»“æŸæ—¶é—´, True, èµ·å§‹æ—¥æœŸ)
        
        # æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
        logger.debug(f"APIè°ƒç”¨è¿”å›æ•°æ®: {bool(æ•°æ®)}")
        if æ•°æ®:
            logger.debug(f"æ•°æ®ç»“æ„: {list(æ•°æ®.keys())}")
            if "resp_data" in æ•°æ®:
                resp_data = æ•°æ®["resp_data"]
                logger.debug(f"resp_dataç±»å‹: {type(resp_data)}, å†…å®¹: {resp_data is not None}")
                if resp_data and isinstance(resp_data, dict):
                    logger.debug(f"resp_dataé”®: {list(resp_data.keys())}")
                    if "topics" in resp_data:
                        topics = resp_data.get("topics")
                        logger.debug(f"topicsç±»å‹: {type(topics)}, é•¿åº¦: {len(topics) if topics else 'None'}")
        
        # æ£€æŸ¥å„ä¸ªæ¡ä»¶
        æ¡ä»¶1 = not æ•°æ®
        æ¡ä»¶2 = "resp_data" not in æ•°æ® if æ•°æ® else True
        æ¡ä»¶3 = not æ•°æ®["resp_data"].get("topics") if æ•°æ® and "resp_data" in æ•°æ® else True
        
        logger.debug(f"åœæ­¢æ¡ä»¶æ£€æŸ¥: notæ•°æ®={æ¡ä»¶1}, no_resp_data={æ¡ä»¶2}, no_topics={æ¡ä»¶3}")
        
        # ğŸ”„ æ–°å¢é‡è¯•é€»è¾‘ï¼šå½“APIæ²¡æœ‰è¿”å›è¯é¢˜æ—¶ï¼Œç­‰å¾…åé‡è¯•
        if not æ•°æ® or "resp_data" not in æ•°æ® or not æ•°æ®["resp_data"].get("topics"):
            è¿ç»­ç©ºå“åº”æ¬¡æ•° += 1
            logger.warning(f"âš ï¸  APIæ²¡æœ‰è¿”å›æ›´å¤šè¯é¢˜ (ç¬¬{è¿ç»­ç©ºå“åº”æ¬¡æ•°}/{æœ€å¤§é‡è¯•æ¬¡æ•°}æ¬¡)")
            
            if è¿ç»­ç©ºå“åº”æ¬¡æ•° >= æœ€å¤§é‡è¯•æ¬¡æ•°:
                logger.warning(f"ğŸš« è¿ç»­{æœ€å¤§é‡è¯•æ¬¡æ•°}æ¬¡æ²¡æœ‰è·å–åˆ°è¯é¢˜ï¼Œåœæ­¢è·å–")
                break
            else:
                ç­‰å¾…æ—¶é—´ = random.uniform(*API_RETRY_DELAY)  # éšæœºç­‰å¾…
                logger.info(f"â° ç­‰å¾… {ç­‰å¾…æ—¶é—´:.1f} ç§’åé‡è¯•...")
                time.sleep(ç­‰å¾…æ—¶é—´)
                continue  # é‡è¯•å½“å‰é¡µ
        else:
            # é‡ç½®è¿ç»­ç©ºå“åº”è®¡æ•°å™¨
            è¿ç»­ç©ºå“åº”æ¬¡æ•° = 0

        åŸå§‹è¯é¢˜åˆ—è¡¨ = æ•°æ®["resp_data"]["topics"]
        åŸå§‹æ•°é‡ = len(åŸå§‹è¯é¢˜åˆ—è¡¨)
        
        # æ£€æŸ¥æ˜¯å¦é‡åˆ°æ›´æ—©çš„æ—¥æœŸ - è¿™æ˜¯æ–°çš„å…³é”®é€»è¾‘
        é‡åˆ°æ›´æ—©æ—¥æœŸ = False
        ç¬¦åˆæ¡ä»¶è¯é¢˜ = []
        
        for è¯é¢˜ in åŸå§‹è¯é¢˜åˆ—è¡¨:
            è¯é¢˜æ—¥æœŸ = è¯é¢˜.get("create_time", "")[:10]
            
            if èµ·å§‹æ—¥æœŸ:
                # æŒ‡å®šæ—¥æœŸèŒƒå›´ï¼šåªè¦æ˜¯æŒ‡å®šæ—¥æœŸæˆ–ä¹‹åçš„éƒ½è¦
                if è¯é¢˜æ—¥æœŸ >= èµ·å§‹æ—¥æœŸ:
                    ç¬¦åˆæ¡ä»¶è¯é¢˜.append(è¯é¢˜)
                else:
                    # é‡åˆ°æ¯”èµ·å§‹æ—¥æœŸæ›´æ—©çš„è¯é¢˜ï¼Œåœæ­¢
                    logger.info(f"ğŸ”š é‡åˆ°æ›´æ—©æ—¥æœŸè¯é¢˜: {è¯é¢˜æ—¥æœŸ} < {èµ·å§‹æ—¥æœŸ}ï¼Œåœæ­¢è·å–")
                    é‡åˆ°æ›´æ—©æ—¥æœŸ = True
                    break
            else:
                # ä»Šæ—¥è¯é¢˜ï¼šåªè¦ä»Šæ—¥çš„
                if è¯é¢˜æ—¥æœŸ == ç›®æ ‡æ—¥æœŸ:
                    ç¬¦åˆæ¡ä»¶è¯é¢˜.append(è¯é¢˜)
                elif è¯é¢˜æ—¥æœŸ < ç›®æ ‡æ—¥æœŸ:
                    # é‡åˆ°æ˜¨å¤©æˆ–æ›´æ—©çš„è¯é¢˜ï¼Œåœæ­¢
                    logger.info(f"ğŸ”š é‡åˆ°æ˜¨å¤©æˆ–æ›´æ—©è¯é¢˜: {è¯é¢˜æ—¥æœŸ} < {ç›®æ ‡æ—¥æœŸ}ï¼Œåœæ­¢è·å–")
                    é‡åˆ°æ›´æ—©æ—¥æœŸ = True
                    break
                else:
                    # æœªæ¥æ—¥æœŸï¼Œè·³è¿‡ä½†ç»§ç»­
                    logger.debug(f"è·³è¿‡æœªæ¥æ—¥æœŸè¯é¢˜: {è¯é¢˜æ—¥æœŸ} > {ç›®æ ‡æ—¥æœŸ}")
        
        logger.info(f"âœ… ç¬¬{é¡µç }é¡µï¼šä»åŸå§‹{åŸå§‹æ•°é‡}ä¸ªè¯é¢˜ä¸­è¿‡æ»¤å‡º ã€{len(ç¬¦åˆæ¡ä»¶è¯é¢˜)}ä¸ªã€‘ ç¬¦åˆæ¡ä»¶çš„è¯é¢˜")
        
        # å°†ç¬¦åˆæ¡ä»¶çš„è¯é¢˜æ·»åŠ åˆ°ç»“æœä¸­
        if ç¬¦åˆæ¡ä»¶è¯é¢˜:
            æ‰€æœ‰è¯é¢˜.extend(ç¬¦åˆæ¡ä»¶è¯é¢˜)
            logger.info(f"ğŸ¯ ç´¯è®¡è·å–åˆ° ã€{len(æ‰€æœ‰è¯é¢˜)}ä¸ªã€‘ ç¬¦åˆæ¡ä»¶çš„è¯é¢˜")
        
        # å¦‚æœé‡åˆ°æ›´æ—©æ—¥æœŸï¼Œåœæ­¢è·å–
        if é‡åˆ°æ›´æ—©æ—¥æœŸ:
            break
            
        # è·å–ä¸‹ä¸€é¡µçš„ç»“æŸæ—¶é—´ï¼Œä½¿ç”¨åŸå§‹è¯é¢˜åˆ—è¡¨çš„æœ€åä¸€ä¸ªè¯é¢˜æ—¶é—´
        if åŸå§‹è¯é¢˜åˆ—è¡¨:
            æœ€åè¯é¢˜æ—¶é—´ = åŸå§‹è¯é¢˜åˆ—è¡¨[-1]["create_time"]
            # å°†æ—¶é—´æˆ³å‡å»1æ¯«ç§’é¿å…é‡å¤
            try:
                from datetime import datetime
                dt = datetime.fromisoformat(æœ€åè¯é¢˜æ—¶é—´.replace('+0800', '+08:00'))
                dt = dt.replace(microsecond=dt.microsecond - 1000 if dt.microsecond >= 1000 else 999000)
                ç»“æŸæ—¶é—´ = dt.strftime('%Y-%m-%dT%H:%M:%S.%f')[:-3] + '+0800'
            except:
                # å¦‚æœæ—¶é—´è§£æå¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨åŸæ—¶é—´
                ç»“æŸæ—¶é—´ = æœ€åè¯é¢˜æ—¶é—´
        else:
            ç»“æŸæ—¶é—´ = ""
            
        # å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœé¡µæ•°è¿‡å¤šï¼Œåœæ­¢è·å–ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
        if é¡µç  >= config.MAX_TOPIC_PAGES:  # æœ€å¤šè·å–config.MAX_TOPIC_PAGESé¡µï¼Œæ¯é¡µ60ä¸ªè¯é¢˜
            logger.warning(f"âš ï¸  å·²è·å–{é¡µç }é¡µè¯é¢˜ï¼Œä¸ºé˜²æ­¢æ— é™å¾ªç¯ï¼Œåœæ­¢è·å–")
            break
            
        time.sleep(1)  # å¯¹APIå‹å¥½

    # æ˜¾è‘—çš„åˆ†é¡µæ€»ç»“æ—¥å¿—
    logger.info("=" * 60)
    logger.info(f"ğŸ“Š è¯é¢˜è·å–å®Œæˆï¼æ€»å…±è·å–äº† ã€{len(æ‰€æœ‰è¯é¢˜)}ä¸ªã€‘ ç¬¦åˆæ¡ä»¶çš„è¯é¢˜")
    logger.info(f"ğŸ“‹ å…±æœç´¢äº† ã€{é¡µç }é¡µã€‘")
    logger.info("=" * 60)
    
    return æ‰€æœ‰è¯é¢˜

# ä¿ç•™åŸå‡½æ•°ä½œä¸ºå…¼å®¹æ€§æ¥å£
def è·å–æ‰€æœ‰è¯é¢˜(æœ€å¤§é¡µæ•°: int, ä»…ä»Šæ—¥: bool = True, èµ·å§‹æ—¥æœŸ: str = "") -> List[Dict[str, Any]]:
    """
    å…¼å®¹æ€§æ¥å£ï¼šä¿æŒåŸAPIä¸å˜ï¼Œå†…éƒ¨è°ƒç”¨æ–°çš„åŸºäºå†…å®¹çš„è·å–é€»è¾‘
    """
    if ä»…ä»Šæ—¥ and not èµ·å§‹æ—¥æœŸ:
        return è·å–æ‰€æœ‰ä»Šæ—¥è¯é¢˜()
    elif èµ·å§‹æ—¥æœŸ:
        return è·å–æ‰€æœ‰ä»Šæ—¥è¯é¢˜(èµ·å§‹æ—¥æœŸ)
    else:
        # å¯¹äºéä»Šæ—¥è¯é¢˜ï¼Œä»ä½¿ç”¨åŸé€»è¾‘ï¼ˆä½†ç°åœ¨å¾ˆå°‘ä½¿ç”¨ï¼‰
        logger.warning("è·å–éä»Šæ—¥è¯é¢˜ï¼Œä½¿ç”¨åŸå§‹åˆ†é¡µé€»è¾‘")
        return _è·å–æ‰€æœ‰è¯é¢˜_åŸé€»è¾‘(æœ€å¤§é¡µæ•°, ä»…ä»Šæ—¥, èµ·å§‹æ—¥æœŸ)

def _è·å–æ‰€æœ‰è¯é¢˜_åŸé€»è¾‘(æœ€å¤§é¡µæ•°: int, ä»…ä»Šæ—¥: bool = True, èµ·å§‹æ—¥æœŸ: str = "") -> List[Dict[str, Any]]:
    """
    åŸå§‹çš„åŸºäºé¡µæ•°çš„è·å–é€»è¾‘ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
    """
    # æš‚æ—¶è¿”å›ç©ºåˆ—è¡¨ï¼Œè¿™ä¸ªå‡½æ•°ç°åœ¨å¾ˆå°‘ä½¿ç”¨
    logger.warning("ä½¿ç”¨åŸå§‹åˆ†é¡µé€»è¾‘ï¼Œå»ºè®®ä½¿ç”¨æ–°çš„åŸºäºå†…å®¹çš„è·å–æ–¹å¼")
    return []

class ZsxqClient:
    def __init__(self, progress_callback=None):
        self.progress_callback = progress_callback

    def on_progress(self, current: int, message: str):
        """è¿›åº¦å›è°ƒ"""
        if self.progress_callback:
            self.progress_callback(current, message)

    def _fetch_page_with_retries(self, end_cursor: Optional[str], page_num: int) -> Optional[List[Dict]]:
        """
        å¸¦é‡è¯•é€»è¾‘çš„å•é¡µè¯é¢˜è·å–
        :param end_cursor: ä¸Šä¸€é¡µçš„ç»“æŸæ—¶é—´æˆ³ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€é¡µåˆ™ä¸ºNone
        :param page_num: å½“å‰é¡µç  (ä»…ç”¨äºæ—¥å¿—è®°å½•)
        :return: æˆåŠŸåˆ™è¿”å›è¯é¢˜åˆ—è¡¨ï¼Œå¤±è´¥åˆ™è¿”å›None
        """
        for attempt in range(config.API_RETRY_TIMES):
            try:
                # logger.info(f"ğŸ” å‡†å¤‡è·å–ç¬¬ ã€{page_num}ã€‘ é¡µ (ç¬¬ {attempt + 1}/{config.API_RETRY_TIMES} æ¬¡å°è¯•)...")
                topics_in_page = self._get_single_page_topics(end_cursor)
                
                # å³ä½¿è¿”å›ç©ºåˆ—è¡¨ï¼Œä¹Ÿè§†ä¸ºæˆåŠŸè·å–ï¼Œå› ä¸ºè¿™å¯èƒ½æ„å‘³ç€æ²¡æœ‰æ›´å¤šå†…å®¹
                return topics_in_page

            except Exception as e:
                logger.error(f"âŒ è·å–ç¬¬ {page_num} é¡µæ—¶å‘ç”Ÿé”™è¯¯: {e}")
                if attempt < config.API_RETRY_TIMES - 1:
                    delay = random.uniform(config.API_RETRY_DELAY[0], config.API_RETRY_DELAY[1])
                    logger.info(f"â° ç­‰å¾… {delay:.1f} ç§’åé‡è¯•...")
                    time.sleep(delay)
                else:
                    logger.error(f"âŒ ç¬¬ {page_num} é¡µé‡è¯• {config.API_RETRY_TIMES} æ¬¡åä»ç„¶å¤±è´¥ã€‚")
                    return None # æ‰€æœ‰é‡è¯•å¤±è´¥
        return None

    def get_all_topics(self, from_date: Optional[datetime] = None, progress_callback: Optional[Callable] = None) -> List[Dict]:
        """
        è·å–ä»æŒ‡å®šæ—¥æœŸåˆ°ç°åœ¨çš„å…¨éƒ¨è¯é¢˜ï¼Œå¹¶ä¿®å¤äº†é‡è¯•é€»è¾‘
        """
        if from_date is None:
            from_date = datetime.now(timezone.utc).replace(hour=0, minute=0, second=0, microsecond=0)
        
        all_topics: List[Dict] = []
        page_num = 0
        end_cursor = None
        
        while True:
            page_num += 1

            if page_num > config.MAX_TOPIC_PAGES:
                logger.warning(f"âš ï¸  å·²è¾¾åˆ°æœ€å¤§æŠ“å–é¡µæ•°é™åˆ¶ ({config.MAX_TOPIC_PAGES}é¡µ)ï¼Œä¸ºé˜²æ­¢æ— é™å¾ªç¯ï¼Œåœæ­¢è·å–ã€‚")
                break

            # --- å¸¦é‡è¯•çš„å•é¡µè·å–é€»è¾‘ ---
            current_page_topics = None
            for attempt in range(config.API_RETRY_TIMES):
                try:
                    logger.info(f"ğŸ” æ­£åœ¨è·å–ç¬¬ ã€{page_num}ã€‘ é¡µ (ç¬¬ {attempt + 1}/{config.API_RETRY_TIMES} æ¬¡å°è¯•)...")
                    
                    # ç›´æ¥è°ƒç”¨åº•å±‚çš„å•é¡µè·å–å‡½æ•°
                    current_page_topics = self._get_single_page_topics(end_cursor)
                    
                    # æˆåŠŸè·å–ï¼ˆå³ä½¿æ˜¯ç©ºåˆ—è¡¨ï¼‰ï¼Œè·³å‡ºé‡è¯•å¾ªç¯
                    break 
                except Exception as e:
                    logger.error(f"âŒ è·å–ç¬¬ {page_num} é¡µæ—¶å‘ç”Ÿé”™è¯¯: {e}")
                    if attempt < config.API_RETRY_TIMES - 1:
                        delay = random.uniform(config.API_RETRY_DELAY[0], config.API_RETRY_DELAY[1])
                        logger.info(f"â° ç­‰å¾… {delay:.1f} ç§’åé‡è¯•...")
                        time.sleep(delay)
                    else:
                        logger.error(f"âŒ ç¬¬ {page_num} é¡µé‡è¯• {config.API_RETRY_TIMES} æ¬¡åä»ç„¶å¤±è´¥ã€‚")
                # --- é‡è¯•é€»è¾‘ç»“æŸ ---

            if current_page_topics is None:
                # æ‰€æœ‰é‡è¯•å‡å¤±è´¥ï¼Œç»ˆæ­¢æ•´ä¸ªä»»åŠ¡
                logger.error("APIè¯·æ±‚è¿ç»­å¤±è´¥ï¼Œç»ˆæ­¢æŠ“å–ä»»åŠ¡ã€‚")
                break
            
            if not current_page_topics:
                # æ­£å¸¸ç»“æŸï¼ŒAPIè¿”å›ç©ºåˆ—è¡¨ï¼Œæ„å‘³ç€æ²¡æœ‰æ›´å¤šå†…å®¹äº†
                logger.info("âœ… å·²è·å–æ‰€æœ‰è¯é¢˜ï¼ŒAPIè¿”å›ç©ºï¼Œç¡®è®¤æŠ“å–ç»“æŸã€‚")
                break

            # æ£€æŸ¥å¹¶è¿‡æ»¤è¯é¢˜
            should_stop, topics_to_add = self._check_and_filter_topics(current_page_topics, from_date)
            
            if topics_to_add:
                all_topics.extend(topics_to_add)
                # åªæœ‰åœ¨æˆåŠŸæ·»åŠ è¯é¢˜åï¼Œæ‰æ›´æ–°æ¸¸æ ‡
                end_cursor = all_topics[-1]['create_time']
                if progress_callback:
                    progress_callback(len(all_topics), f"å·²è·å– {len(all_topics)} æ¡æœ‰æ•ˆè¯é¢˜")

            if should_stop:
                logger.info("â„¹ï¸ é‡åˆ°æ—©äºæŒ‡å®šæ—¥æœŸçš„è¯é¢˜ï¼ŒæŠ“å–ç»“æŸã€‚")
                break

        logger.info(f"âœ”ï¸ è¯é¢˜è·å–å®Œæˆï¼Œå…±æ‰¾åˆ° {len(all_topics)} æ¡è¯é¢˜ã€‚")
        return all_topics

    def _check_and_filter_topics(self, topics: List[Dict], from_date: datetime) -> Tuple[bool, List[Dict]]:
        """
        æ£€æŸ¥è¯é¢˜æ˜¯å¦æ—©äºæŒ‡å®šæ—¥æœŸï¼Œå¹¶è¿”å›éœ€è¦æ·»åŠ çš„è¯é¢˜åˆ—è¡¨
        :return: (æ˜¯å¦åº”è¯¥åœæ­¢, éœ€è¦æ·»åŠ çš„è¯é¢˜åˆ—è¡¨)
        """
        topics_to_add = []
        should_stop = False
        
        for topic in topics:
            create_time_str = topic.get("create_time", "")
            if not create_time_str:
                continue
            
            try:
                # è½¬æ¢æ—¶é—´å­—ç¬¦ä¸²ä¸ºå¸¦æ—¶åŒºçš„datetimeå¯¹è±¡
                topic_time = datetime.fromisoformat(create_time_str.replace('Z', '+00:00'))
                
                if topic_time < from_date:
                    should_stop = True
                    break # é‡åˆ°æ—©äºæŒ‡å®šæ—¥æœŸçš„è¯é¢˜ï¼Œåç»­ä¸å†å¤„ç†
                else:
                    topics_to_add.append(topic)
            except ValueError:
                logger.warning(f"æ— æ³•è§£ææ—¶é—´æ ¼å¼: {create_time_str}")
                continue

        return should_stop, topics_to_add

    def _get_single_page_topics(self, end_cursor: Optional[str] = None) -> List[Dict]:
        """
        è·å–å•é¡µè¯é¢˜ï¼ˆæœ€å¤š60ä¸ªï¼‰
        :param end_cursor: ä¸Šä¸€é¡µçš„æœ€åä¸€ä¸ªè¯é¢˜çš„create_timeï¼Œç”¨äºåˆ†é¡µ
        :return: è¯é¢˜åˆ—è¡¨
        """
        headers = {
            "Cookie": COOKIE,
            "Host": API_HOST,
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
            "Referer": f"https://wx.zsxq.com/dweb2/index/group/{STAR_ID}",
        }
        
        params = {
            "scope": "all",
            "count": 60,
        }
        if end_cursor:
            params["end_time"] = end_cursor

        url = f"{API_BASE_URL}/{STAR_ID}/topics"
        
        try:
            response = requests.get(url, headers=headers, params=params, timeout=API_TIMEOUT)
            response.raise_for_status()
            data = response.json()

            if data.get("succeeded"):
                return data.get("resp_data", {}).get("topics", [])
            else:
                logger.error(f"APIè¯·æ±‚å¤±è´¥: {data.get('info', 'æœªçŸ¥é”™è¯¯')}")
                raise requests.RequestException(f"API Error: {data.get('info', 'æœªçŸ¥é”™è¯¯')}")

        except requests.exceptions.RequestException as e:
            logger.error(f"è¯·æ±‚ zsxq API å¤±è´¥: {e}")
            raise

if __name__ == '__main__':
    if not COOKIE or not STAR_ID:
        logger.error("âŒ è¯·åœ¨ config.py æ–‡ä»¶ä¸­é…ç½® COOKIE å’Œ STAR_ID")
    else:
        # æµ‹è¯•ä»3å¤©å‰è·å–
        three_days_ago = datetime.now(timezone.utc) - timedelta(days=3)
        
        def simple_progress(current, message):
            print(f"[è¿›åº¦] -> {message}")
            
        print(f"ğŸš€ å¼€å§‹æµ‹è¯•è·å–ä» {three_days_ago.strftime('%Y-%m-%d')} å¼€å§‹çš„è¯é¢˜...")
        topics = get_all_topics(from_date=three_days_ago, progress_callback=simple_progress)
        
        if topics:
            print(f"\nâœ… æµ‹è¯•æˆåŠŸï¼å…±è·å–åˆ° {len(topics)} ä¸ªè¯é¢˜ã€‚")
            print("éƒ¨åˆ†è¯é¢˜æ ‡é¢˜:")
            for t in topics[:5]:
                title = t.get('talk', {}).get('text', 'æ— æ ‡é¢˜')[:30]
                print(f"  - {title}...")
        else:
            print("\nâš ï¸ æµ‹è¯•ç»“æŸï¼Œæ²¡æœ‰è·å–åˆ°ä»»ä½•è¯é¢˜ã€‚")
